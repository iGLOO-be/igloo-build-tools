#!/usr/bin/env sh

# # Config
# IMAGE_SUFFIX (default: "") : Append a string at the end of the image name
# KUBE_NAMESPACE_ENV (default: "") : Append a string a the end of the k8s namespace

set -e

. docker-login

export SCOPE_NAME=$( echo $CI_PROJECT_NAMESPACE-$CI_PROJECT_NAME | tr '[:upper:]' '[:lower:]' )

export IMAGE_TAG=$CI_PIPELINE_ID
tag=""
if [ "$CI_COMMIT_TAG" != "" ]; then
  tag=$CI_COMMIT_TAG
elif [ "$CI_BUILD_TAG" != "" ]; then
  # Since gitlab@9
  tag=$CI_BUILD_TAG
elif [ "$CI_PIPELINE_ID" != "" ]; then
  echo "Warning: missing CI_BUILD_TAG env variable!"
  echo "Fallback to pipeline id: $CI_PIPELINE_ID"
  tag=$CI_PIPELINE_ID
else
  echo "Error: missing env variable for identify image tag."
  echo "Are you running on GitLab CI ?"
  exit 1
fi
export RELASE_IMAGE_TAG=$tag

# Base image like 123.dkr.ecr.eu-west-1.amazonaws.com/igloo/igloo-devops-gitlab-ci-kubernetes
# From docker-login
IMAGE_PATH=$DOCKER_IMAGE_PREFIX$IMAGE_SUFFIX

# Test image like $IMAGE_PATH:[pipeline-id]
export TEST_IMAGE_PATH=$IMAGE_PATH:$IMAGE_TAG
# Latest release, aka latest
export RELEASE_IMAGE_LATEST_PATH=$IMAGE_PATH:latest
# Tagged release, aka v1.2.3
export RELEASE_IMAGE_TAG_PATH=$IMAGE_PATH:$RELASE_IMAGE_TAG

namespace=$SCOPE_NAME
if [ "$KUBE_NAMESPACE_ENV" != "" ]; then
  namespace="$namespace-$KUBE_NAMESPACE_ENV"
fi

export KUBE_NAMESPACE=$namespace
export KUBE_IMAGE=$RELEASE_IMAGE_TAG_PATH
export KUBE_DEPLOY_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
