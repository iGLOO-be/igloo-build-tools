#!/usr/bin/env sh

set -e

. ci-setup-k8s

dir=`pwd`/`dirname $1`

rootDeployDir=$dir
while [ "$rootDeployDir" != "/" ] ; do
  if [ `find "$rootDeployDir" -maxdepth 1 -name default-env` ]; then
    break
  fi
  rootDeployDir=`dirname "$rootDeployDir"`
done

TMP_DIR="./.kube-deploy"
mkdir -p $TMP_DIR

if [ -f $rootDeployDir/default-env ]; then
  export $(cat $rootDeployDir/default-env | xargs)
  echo "Loaded default-env: $rootDeployDir/default-env"
fi

for f in $1
do
  TMP_FILE="./.kube-deploy/$(basename $f)"
  cat $f \
    | envsubst \
    > $TMP_FILE

  echo "Deploy: $TMP_FILE"
  kubectl apply -f $TMP_FILE
done
