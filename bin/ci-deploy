#!/usr/bin/env sh

set -e

. ci-setup-k8s

dir=`dirname "$(pwd)/$1"`

if [ -d "$dir" ]; then
  rootDeployDir=$dir
  while [ "$rootDeployDir" != "/" ] ; do
    if [ `find "$rootDeployDir" -maxdepth 1 -name default-env` ]; then
      eval $(cat $rootDeployDir/default-env | sed 's/\(.*\)=\(.*\)/export \1=${\1:-\2}/g' | xargs)
      echo "Loaded default-env: $rootDeployDir/default-env"

      break
    fi
    rootDeployDir=`dirname "$rootDeployDir"`
  done
fi

TMP_DIR="./.kube-deploy"
mkdir -p $TMP_DIR

for f in $1
do
  TMP_FILE="./.kube-deploy/$(basename $f)"
  cat $f \
    | envsubst \
    > $TMP_FILE

  echo "Deploy: $TMP_FILE"
  kubectl apply -f $TMP_FILE
  kubectl describe -f ~/Downloads/deploy.yaml
done
